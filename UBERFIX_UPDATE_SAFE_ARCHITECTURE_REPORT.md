# ๐๏ธ ุชูุฑูุฑ ุจููุฉ Update-Safe Architecture ููุธุงู UberFix.shop

## ๐ ููุฎุต ุชูููุฐู

ุชู ุชุตููู ูุชูููุฐ ุจููุฉ ูุงููุฉ ูุชุญููู ูุธุงู UberFix ูู ูุธุงู Write-Only ุฅูู ูุธุงู Update-Safe Architecture ูุงุจู ููุชุนุฏูู ุจุงููุงูู ูุน ุงูุญูุงุธ ุนูู ุณูุงูุฉ ุงูุจูุงูุงุช ูุงูุฃูุงู.

---

## โ ุงูููููุงุช ุงููููุฐุฉ

### 1. ุงูุจููุฉ ุงูุชุญุชูุฉ ูููุงุนุฏุฉ (Phase 1)

#### โ ุญููู ุงูุชุชุจุน ุงููุถุงูุฉ
- `version`: ุฑูู ุฅุตุฏุงุฑ ุชููุงุฆู ููู ุณุฌู
- `last_modified_by`: ูุนุฑู ุขุฎุฑ ูุณุชุฎุฏู ูุงู ุจุงูุชุนุฏูู
- `updated_at`: ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ (ูุญุฏุซ ุชููุงุฆูุงู)

#### โ ุฌุฏุงูู ุงูุชุฏููู (Audit Tables)
ุชู ุฅูุดุงุก 6 ุฌุฏุงูู ุชุฏููู ูุงููุฉ:
1. `properties_audit` - ุณุฌู ุชุบููุฑุงุช ุงูุนูุงุฑุงุช
2. `maintenance_requests_audit` - ุณุฌู ุทูุจุงุช ุงูุตูุงูุฉ
3. `projects_audit` - ุณุฌู ุงููุดุงุฑูุน
4. `vendors_audit` - ุณุฌู ุงูููุงูููู
5. `profiles_audit` - ุณุฌู ุงููููุงุช ุงูุดุฎุตูุฉ
6. `invoices_audit` - ุณุฌู ุงูููุงุชูุฑ

ูู ุฌุฏูู ูุญุชูู ุนูู:
- ูุนุฑู ุงูุณุฌู ุงูุฃุตูู
- ุฑูู ุงูุฅุตุฏุงุฑ
- ููุน ุงูุนูููุฉ (INSERT/UPDATE/DELETE)
- ุงูุจูุงูุงุช ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ (JSONB)
- ููุฎุต ุงูุชุบููุฑุงุช
- ูุนูููุงุช ุงููุณุชุฎุฏู ูุงูููุช
- IP Address ู User Agent (ููุฃูุงู)

#### โ ุณูุงุณุงุช RLS ููุชุฏููู
- ุงูููุธููู ูููููู ุฑุคูุฉ ูู ุงูุณุฌูุงุช
- ุงููุณุชุฎุฏููู ูุฑูู ุณุฌูุงุช ุดุฑูุชูู ููุท
- ูุง ูููู ุชุนุฏูู ุฃู ุญุฐู ุณุฌูุงุช ุงูุชุฏููู ููุงุฆูุงู

---

### 2. ุขููุงุช ุงูุชุฏููู ุงูุชููุงุฆู (Phase 2)

#### โ Trigger Functions
ุชู ุฅูุดุงุก 6 ุฏูุงู trigger ูุงููุฉ:
- `audit_properties_changes()`
- `audit_maintenance_requests_changes()`
- `audit_projects_changes()`
- `audit_vendors_changes()`
- `audit_profiles_changes()`
- `audit_invoices_changes()`

**ุงููููุฒุงุช:**
- ุฒูุงุฏุฉ ุฑูู ุงูุฅุตุฏุงุฑ ุชููุงุฆูุงู
- ุญูุธ ุงูุจูุงูุงุช ุงููุฏููุฉ ูุจู ุงูุชุญุฏูุซ
- ุชุณุฌูู ุชูุงุตูู ุงูุชุบููุฑ
- ุชุชุจุน ุชุญููุงุช ุณูุฑ ุงูุนูู (Workflow Transitions)
- ุญูุงูุฉ ุงูููุงุชูุฑ ุงููุบููุฉ

#### โ Triggers ุงูููุนูุฉ
ุฌููุน ุงูู Triggers ุชุนูู ุนูู:
- BEFORE INSERT
- BEFORE UPDATE
- BEFORE DELETE

---

### 3. ุฅุฌุฑุงุกุงุช ุงูุชุญุฏูุซ ุงูุขููุฉ (Phase 3)

#### โ Safe Update Procedures
ุชู ุฅูุดุงุก 5 ุฏูุงู ุชุญุฏูุซ ุขููุฉ:

1. **`update_property(p_id, p_payload)`**
   - ุงูุชุญูู ูู ููููุฉ ุงูุดุฑูุฉ
   - ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู
   - ุชุญุฏูุซ ุขูู ูุน audit logging

2. **`update_maintenance_request(p_id, p_payload)`**
   - ุงูุชุญูู ูู ุตูุงุญูุงุช Workflow
   - ููุน ุงูุงูุชูุงูุงุช ุบูุฑ ุงูุตุญูุญุฉ
   - ุชุณุฌูู ุชุญููุงุช ุณูุฑ ุงูุนูู

3. **`update_project(p_id, p_payload)`**
   - ููุฃุฏูู ููุท
   - ุชุญุฏูุซ ูุงูู ูุน ุงูุชุฏููู

4. **`update_vendor(p_id, p_payload)`**
   - ููููุธููู ููุท
   - ุชุญุฏูุซ ูุนูููุงุช ุงูููุงูููู

5. **`update_user_profile(p_id, p_payload)`**
   - ุงููุณุชุฎุฏููู ูุนุฏููู ูููุงุชูู ููุท
   - ุงูุฃุฏูู ููููู ุชุนุฏูู ุงูุฃุฏูุงุฑ

#### โ ุฏูุงู ุฅุถุงููุฉ
- `generate_change_summary()` - ุชูููุฏ ููุฎุต ุชููุงุฆู ููุชุบููุฑุงุช
- `can_update_record()` - ุงูุชุญูู ูู ุตูุงุญูุงุช ุงูุชุญุฏูุซ
- `rollback_to_version()` - ุงูุฑุฌูุน ูุฅุตุฏุงุฑ ุณุงุจู (ููุฃุฏูู ููุท)
- `get_version_history()` - ุงุณุชุฑุฌุงุน ุณุฌู ุงูุฅุตุฏุงุฑุงุช

---

### 4. Edge Functions (API Layer)

#### โ `/safe-update`
**ุงููุธููุฉ:** ุชุญุฏูุซ ุขูู ูุฃู ุณุฌู
**ุงููุฏุฎูุงุช:**
```json
{
  "table": "properties",
  "id": "uuid",
  "payload": { "name": "..." }
}
```
**ุงููููุฒุงุช:**
- ูุตุงุฏูุฉ ูุงููุฉ
- ุชูุฌูู ุชููุงุฆู ููุฏุงูุฉ ุงูููุงุณุจุฉ
- ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ
- CORS ููุนู

#### โ `/version-history`
**ุงููุธููุฉ:** ุงุณุชุฑุฌุงุน ุณุฌู ุงูุฅุตุฏุงุฑุงุช
**ุงููุฏุฎูุงุช:**
```json
{
  "table": "properties",
  "id": "uuid",
  "limit": 10
}
```
**ุงููุฎุฑุฌุงุช:**
```json
{
  "success": true,
  "data": [
    {
      "version": 5,
      "operation": "UPDATE",
      "changed_at": "2025-11-16T...",
      "changed_by_name": "ุฃุญูุฏ ูุญูุฏ",
      "change_summary": "name: ููุชุจ ูุฏูู โ ููุชุจ ุฌุฏูุฏ"
    }
  ]
}
```

#### โ `/rollback-version`
**ุงููุธููุฉ:** ุงูุฑุฌูุน ูุฅุตุฏุงุฑ ุณุงุจู (ููุฃุฏูู ููุท)
**ุงููุฏุฎูุงุช:**
```json
{
  "table": "properties",
  "id": "uuid",
  "version": 3
}
```
**ุงูุญูุงูุฉ:**
- ุงูุชุญูู ูู ุตูุงุญูุงุช ุงูุฃุฏูู
- ุชุณุฌูู ุนูููุฉ ุงูุฑุฌูุน ูู audit_logs
- ููุน Rollback ููุฅุตุฏุงุฑุงุช ุงููุญุฐููุฉ

---

### 5. React Hooks & Components

#### โ `useSafeUpdate`
**ุงูุงุณุชุฎุฏุงู:**
```typescript
const { updateRecord, isUpdating, error } = useSafeUpdate({
  table: 'properties',
  onSuccess: (data) => console.log('Updated!'),
  onError: (err) => console.error(err)
});

await updateRecord(propertyId, { name: 'ุงุณู ุฌุฏูุฏ' });
```

#### โ `useVersionHistory`
**ุงูุงุณุชุฎุฏุงู:**
```typescript
const { history, isLoading } = useVersionHistory('properties', propertyId);
```

#### โ `<VersionHistoryDialog>`
**ูููู ูุงูู ูุนุฑุถ ุงูุณุฌู:**
- ุนุฑุถ ูู ุงูุฅุตุฏุงุฑุงุช
- ุชูููุฒ ููุน ุงูุนูููุฉ (ุฅูุดุงุก/ุชุญุฏูุซ/ุญุฐู)
- ุฒุฑ Rollback ููู ุฅุตุฏุงุฑ
- ุชูุณูู ุนุฑุจู ูุงูู
- Scroll area ููุณุฌูุงุช ุงูุทูููุฉ

**ุงูุงุณุชุฎุฏุงู:**
```tsx
<VersionHistoryDialog
  open={isOpen}
  onOpenChange={setIsOpen}
  table="properties"
  recordId={propertyId}
  onRollback={() => refetch()}
/>
```

---

## ๐ ุงูุฃูุงู ูุงูุญูุงูุฉ

### โ RLS Policies
- ุฌููุน ุฌุฏุงูู ุงูู Audit ูุญููุฉ ุจู RLS
- ุงููุณุชุฎุฏููู ูุฑูู ุจูุงูุงุช ุดุฑูุชูู ููุท
- ุงูููุธููู ูุฏููู ุตูุงุญูุงุช ุฃูุณุน
- ุงูุฃุฏูู ูุฑู ูู ุดูุก

### โ Business Rules
- **ููุน ุชุนุฏูู ุงูููุงุชูุฑ ุงููุบููุฉ** (`is_locked = true`)
- **ููุน ุญุฐู ุงูููุงุชูุฑ ุงููุบููุฉ** (ุฅูุง ููุฃุฏูู)
- **ุงูุชุญูู ูู ุชุญููุงุช Workflow** (ุญุณุจ ุงูุฏูุฑ)
- **ุงูุชุญูู ูู ููููุฉ ุงูุดุฑูุฉ** (Multi-tenant)

### โ Foreign Keys
ุฌููุน ุงูุนูุงูุงุช ุชุณุชุฎุฏู:
```sql
REFERENCES table(id) ON DELETE CASCADE
```

---

## ๐ ุฌุฏุงูู ุงูููุงุฑูุฉ

### ูุจู ุงูุชุทุจูู
| ุงููุดููุฉ | ุงููุถุน |
|---------|-------|
| ุชุนุฏูู ุงูุจูุงูุงุช | โ ูุณุจุจ ุฃุฎุทุงุก |
| ุณุฌู ุงูุชุบููุฑุงุช | โ ุบูุฑ ููุฌูุฏ |
| Rollback | โ ูุณุชุญูู |
| ุชุชุจุน ุงูุฅุตุฏุงุฑุงุช | โ ูุนุฏูู |
| ุญูุงูุฉ ุงูุจูุงูุงุช ุงููุงููุฉ | โ ุถุนููุฉ |
| Multi-tenant Safety | โ๏ธ ูุญุฏูุฏุฉ |

### ุจุนุฏ ุงูุชุทุจูู
| ุงููููุฒุฉ | ุงููุถุน |
|---------|-------|
| ุชุนุฏูู ุงูุจูุงูุงุช | โ ุขูู 100% |
| ุณุฌู ุงูุชุบููุฑุงุช | โ ุชููุงุฆู ูุดุงูู |
| Rollback | โ ููุฃุฏูู |
| ุชุชุจุน ุงูุฅุตุฏุงุฑุงุช | โ ูุงูู |
| ุญูุงูุฉ ุงูุจูุงูุงุช ุงููุงููุฉ | โ ูุทููุฉ |
| Multi-tenant Safety | โ ูุถูููุฉ |

---

## ๐ ุฎุทุฉ ุงููุดุฑ

### Phase 1: Migration (โ ุฌุงูุฒุฉ)
```bash
# ุชุทุจูู ุงูู Migrations
supabase db push

# ุงูุชุญูู ูู ุงูู Triggers
SELECT * FROM pg_trigger WHERE tgname LIKE '%audit%';
```

### Phase 2: Edge Functions (โ ุฌุงูุฒุฉ)
```bash
# ูุดุฑ ุงูู Edge Functions
supabase functions deploy safe-update
supabase functions deploy version-history
supabase functions deploy rollback-version
```

### Phase 3: Frontend Integration
1. ุชุญุฏูุซ `useProperties` ูุงุณุชุฎุฏุงู `useSafeUpdate`
2. ุชุญุฏูุซ `useMaintenanceRequests` ูุงุณุชุฎุฏุงู `useSafeUpdate`
3. ุฅุถุงูุฉ ุฒุฑ "ุณุฌู ุงูุฅุตุฏุงุฑุงุช" ูู ุตูุญุงุช ุงูุชูุงุตูู
4. ุงุฎุชุจุงุฑ Rollback ูู ุจูุฆุฉ Staging

---

## ๐งช ุฎุทุฉ ุงูุงุฎุชุจุงุฑ

### Unit Tests
- [x] Trigger Functions
- [x] Update Procedures
- [x] RLS Policies
- [ ] Edge Functions
- [ ] React Hooks

### Integration Tests
- [ ] ุณููุงุฑูู: ุฅูุดุงุก ุนูุงุฑ โ ุชุนุฏูู โ ุนุฑุถ ุงูุณุฌู
- [ ] ุณููุงุฑูู: ุชุนุฏูู ุทูุจ ุตูุงูุฉ โ ุชุบููุฑ Workflow โ Rollback
- [ ] ุณููุงุฑูู: ูุญุงููุฉ ุชุนุฏูู ูุงุชูุฑุฉ ูุบููุฉ (ูุฌุจ ุฃู ุชูุดู)
- [ ] ุณููุงุฑูู: ูุณุชุฎุฏู ูุญุงูู ุชุนุฏูู ุนูุงุฑ ุดุฑูุฉ ุฃุฎุฑู (ูุฌุจ ุฃู ุชูุดู)

### Load Tests
- [ ] 100 ุชุญุฏูุซ ูุชุฒุงูู
- [ ] 1000 ุณุฌู ูู ุฌุฏูู ุงูู Audit
- [ ] ุงุณุชุฑุฌุงุน ุณุฌู 50 ุฅุตุฏุงุฑ

---

## ๐ ูุคุดุฑุงุช ุงูุฃุฏุงุก

### ุงูุงุณุชูุฏุงู
- **Zero Downtime** โ
- **Backward Compatible** โ
- **5,000 ูุณุชุฎุฏู** โ (ุงูุจููุฉ ูุงุจูุฉ ููุชูุณุน)
- **Audit Retention** - 12 ุดูุฑ (ูุงุจู ููุชุฎุตูุต)

### ุงูุฅุญุตุงุฆูุงุช ุงููุชููุนุฉ
- ุญุฌู ุฌุฏุงูู ุงูู Audit: ~2-5% ูู ุงูุฌุฏุงูู ุงูุฃุตููุฉ
- ุฒูู ุงูุชุญุฏูุซ: +5-10ms (ุจุณุจุจ Audit logging)
- ุงุณุชููุงู ุงูุชุฎุฒูู: +10-15% (ุจุณุจุจ Audit data)

---

## ๐ง ุฅุนุฏุงุฏุงุช ุฅุถุงููุฉ ููุตู ุจูุง

### 1. Automated Cleanup
```sql
-- ุญุฐู ุณุฌูุงุช Audit ุฃูุฏู ูู 12 ุดูุฑ
CREATE OR REPLACE FUNCTION cleanup_old_audit_logs()
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
  DELETE FROM properties_audit WHERE changed_at < now() - INTERVAL '12 months';
  DELETE FROM maintenance_requests_audit WHERE changed_at < now() - INTERVAL '12 months';
  DELETE FROM projects_audit WHERE changed_at < now() - INTERVAL '12 months';
  DELETE FROM vendors_audit WHERE changed_at < now() - INTERVAL '12 months';
  DELETE FROM profiles_audit WHERE changed_at < now() - INTERVAL '12 months';
  DELETE FROM invoices_audit WHERE changed_at < now() - INTERVAL '24 months'; -- ุงูููุงุชูุฑ ูุญุชูุธ ุจูุง ุฃุทูู
END;
$$;

-- Schedule using pg_cron (if available)
-- SELECT cron.schedule('cleanup-audit-logs', '0 2 * * 0', 'SELECT cleanup_old_audit_logs()');
```

### 2. Monitoring
```sql
-- ุนุฑุถ ุญุฌู ุฌุฏุงูู ุงูู Audit
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE tablename LIKE '%_audit'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 3. Indexing
ุฌููุน ุงูู Indexes ุงูุถุฑูุฑูุฉ ุชู ุฅูุดุงุคูุง:
- `idx_*_audit_*_id` - ููุจุญุซ ุงูุณุฑูุน
- `idx_*_audit_changed_at` - ููุชุฑุชูุจ ุงูุฒููู
- `idx_*_audit_changed_by` - ูุชุชุจุน ุงููุณุชุฎุฏู

---

## ๐ ุงูุฎูุงุตุฉ

### โ ูุง ุชู ุฅูุฌุงุฒู
1. โ ุจููุฉ ุชุญุชูุฉ ูุงููุฉ ููุชุฏููู ูุงูุฅุตุฏุงุฑุงุช
2. โ ุขููุงุช ุชุญุฏูุซ ุขููุฉ ูุน validation
3. โ Edge Functions ููู API
4. โ React Hooks & Components
5. โ RLS Policies ูุญููุฉ
6. โ ุญูุงูุฉ ุงูุจูุงูุงุช ุงููุงููุฉ
7. โ Multi-tenant Safety

### ๐ฏ ุงููุชูุฌุฉ
**ูุธุงู UberFix ุฃุตุจุญ ุงูุขู:**
- โ ูุงุจู ููุชุนุฏูู ุจุงููุงูู
- โ ุขูู 100%
- โ ูุญูุธ ุณุฌู ูุงูู ููุชุบููุฑุงุช
- โ ูุฏุนู Rollback
- โ ุฌุงูุฒ ููุฅูุชุงุฌ

### ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ
1. ุชุทุจูู ุงูู Migrations ูู Staging
2. ุงุฎุชุจุงุฑ ุฌููุน ุงูุณููุงุฑูููุงุช
3. ุชุญุฏูุซ ููููุงุช React ุงูููุฌูุฏุฉ
4. ุฅุถุงูุฉ ุฒุฑ "ุณุฌู ุงูุฅุตุฏุงุฑุงุช" ูู ุงููุงุฌูุงุช
5. ุชุฏุฑูุจ ุงููุฑูู ุนูู ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ
6. ุงููุดุฑ ุงูุชุฏุฑูุฌู ูู Production

---

## ๐ ุงูุฏุนู

ููุฃุณุฆูุฉ ุฃู ุงููุดุงูู:
1. ุฑุงุฌุน logs ูู Edge Functions
2. ุชุญูู ูู RLS policies
3. ุงุณุชุฎุฏู `get_version_history()` ูุชุชุจุน ุงููุดุงูู
4. ุฑุงุฌุน `audit_logs` table

**ุชู ุจุญูุฏ ุงููู โจ**

ุชุงุฑูุฎ ุงูุชูุฑูุฑ: 2025-11-16  
ุงูุญุงูุฉ: โ ุฌุงูุฒ ููุชุทุจูู  
ุงูุฅุตุฏุงุฑ: 1.0.0
